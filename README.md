# ESP32 Humidifier (MQTT + Web UI + OTA)

Это прошивка для ESP32, управляющая реле (увлажнитель) по MQTT и через веб-интерфейс с поддержкой OTA.

## Кратко
- Контролирует реле через GPIO (по умолчанию `GPIO23`).
- Управление: веб-интерфейс (Basic Auth), MQTT (темы состояния и команд), Quick control на главной странице.
- Поддержка OTA через PlatformIO / `espota` и веб-обновление по `/update`.

## Важные моменты по подключению реле
- Релейный модуль должен иметь общий GND с ESP32 (общая масса).
- Питание реле: обычно +5V (или 3.3V для некоторых модулей) — см. специфика вашего модуля.
- Входной контакт `IN` на модуле управляется с уровнями GPIO ESP32 (3.3V). Мы определили, что используемый модуль у вас работает как активный HIGH (при 3.3V — реле активируется).
- Рекомендуемая аппаратная стабилизация: подтяжка входа `IN` к GND через 10 kΩ (резистор 10k 1/4W, 5% или 1% — не критично). Это предотвращает краткий импульс при загрузке, если вход остается плавающим.

Схема подключения (типичная):
- ESP32 `GND`  -> Релейный модуль `GND`
- ESP32 `GPIO23` -> Релейный модуль `IN`
- Релейный модуль `VCC` -> внешний +5V (при использовании 5V-модуля)
- При необходимости припаять 10k между `IN` и `GND` на плате реле

Важно: если модуль имеет оптопару и отдельный вход `JD-VCC` для питания катушки, соблюдайте рекомендации модуля (иногда требуется отдельное питание катушки и общая масса).

## Пины и настройки
- По-умолчанию в проекте:
  - `HUM_DEFAULT_RELAY_PIN=23`
  - `HUM_DEFAULT_RELAY_INVERTED=0` (0 = активный HIGH: `relayOn` -> GPIO = HIGH)
- Эти значения можно переопределить в `platformio.ini` через `build_flags` или в веб-интерфейсе в разделе `Control` (Relay pin / Relay inverted).

## Сборка и прошивка (PlatformIO)
1. Установите PlatformIO (VSCode PIO extension или CLI).
2. Сборка для USB (env `esp32dev`):

```powershell
pio run -e esp32dev
```

3. Прошивка по USB (PlatformIO в VSCode или `pio run -e esp32dev -t upload`).

4. OTA-прошивка (env `esp32ota`) — укажите IP устройства в `platformio.ini` или при запуске:

```powershell
pio run -e esp32ota -t upload --upload-port 192.168.1.97
```

(замените IP на IP вашего устройства)

## Веб-интерфейс
- Откройте `http://<IP>/` и авторизуйтесь (по умолчанию `admin:admin`, если не меняли).
- `Quick control` позволяет быстро включить/выключить автоматику и задать `setpoint`.
- Для постоянных настроек: `Save & Reboot` в разделе `Save`.

## MQTT
- Публикуются топики состояния: `state/enabled`, `state/relay` (`ON`/`OFF`), `state/setpoint`, `state/humidity`, `state/reason`.
- Подписки: внешний топик влажности, топик setpoint, топик enable (можно настроить в UI).

## Диагностика
- Логи доступны по `/logs` (и `/logs?plain=1` для текстового вывода).
- Если реле не реагирует при отображении `Relay: ON` в UI:
  - Проверьте, что на GPIO при ON действительно 3.3V (мультиметр).
  - Проверьте общую массу GND.
  - Убедитесь, что `relay_inv` соответствует модулю (0 — ON=HIGH, 1 — ON=LOW).

## Как загрузить этот репозиторий на GitHub
1. Создайте репозиторий на GitHub (или используйте `gh repo create`):

```bash
git init
git add .
git commit -m "Initial commit: firmware + README"
# добавить remote origin
git remote add origin https://github.com/<youruser>/humidifier_mqtt.git
git branch -M main
git push -u origin main
```

Или с GitHub CLI (если настроено):

```bash
gh repo create <youruser>/humidifier_mqtt --public --source=. --remote=origin --push
```

Я могу помочь с этим шагом, если дашь доступ (gh настроен) или хочешь, чтобы я подготовил и попытался выполнить `gh repo create` локально.

## Контакты
Если нужно добавить схему/фото подключения или доработать README — пришли фото, и я вставлю в репозиторий.

---

Автор: проект `humidifier_mqtt` — прошивка для ESP32. Спасибо за тестирование — рад, что всё заработало.
